<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CodeLeader Tree Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <style>
        body { display:flex; height:100vh; margin:0; font-family:sans-serif; }

        /* 左ペイン：ツリー */
        #left-pane { width:40%; border-right:1px solid #ccc; overflow:auto; padding:10px; }

        /* 右ペイン：ノード詳細 */
        #right-pane { width:60%; border-left:1px solid #ccc; overflow:auto; padding:10px; }

        .code-block { background:#f5f5f5; padding:10px; white-space:pre-wrap; font-family:monospace; }
        .modified { background-color:#ffe5e5; }
        .added    { background-color:#e5ffe5; }
        .deleted  { background-color:#e5e5ff; }
    </style>
</head>
<body>

<!-- 左ペイン：ツリー -->
<div id="left-pane">
    <div id="tree"></div>
</div>

<!-- 右ペイン：ノード詳細 -->
<div id="right-pane">
    <h3 id="node-title">ノード詳細</h3>
    <pre id="node-source" class="code-block"></pre>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

<script>
    // ────────── ツリーデータ ──────────
    const treeData = [
        {
            "id": "Hello.java",
            "text": "Hello.java",
            "children": [
                { "id": "Hello.java:greet", "text": "greet()" }
            ]
        }
    ];

    // jsTree 初期化
    $('#tree').jstree({ 'core': { 'data': treeData } });

    // ────────── ノード詳細取得 ──────────
    function loadNodeDetail(nodeId) {
        fetch(`/api/code/node/${encodeURIComponent(nodeId)}`)
            .then(res => {
                if (!res.ok) throw new Error("ノードが見つかりません");
                return res.json();
            })
            .then(data => {
                document.getElementById("node-title").innerText =
                    `${data.type}: ${data.name} (行 ${data.startLine}-${data.endLine})`;

                const sourceEl = document.getElementById("node-source");
                sourceEl.textContent = data.source;
                sourceEl.className = "code-block " + (data.diffStatus || "");
            })
            .catch(err => {
                console.error(err);
                document.getElementById("node-title").innerText = "ノード詳細取得エラー";
                document.getElementById("node-source").textContent = "";
            });
    }

    // ────────── ツリー選択時に右ペイン更新 ──────────
    $('#tree').on("select_node.jstree", function (e, data) {
        const nodeId = data.node.id;
        loadNodeDetail(nodeId);
    });
</script>

</body>
</html>
