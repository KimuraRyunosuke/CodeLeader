<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>CodeLeader â€” æ§‹é€ è§£æï¼†å·®åˆ†è§£æï¼ˆJSONè¡¨ç¤ºç‰ˆï¼‰</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root{
            --bg:#f4f6f8;
            --panel:#ffffff;
            --muted:#6b7280;
            --accent:#2563eb;
            --added-bg:#e6ffed;
            --removed-bg:#ffecec;
            --modified-bg:#fff7e6;
            --card-shadow: 0 6px 18px rgba(15,23,42,0.08);
            --radius:10px;
        }
        html,body{height:100%; margin:0; font-family: Inter, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; background:var(--bg); color:#111827;}
        .container{max-width:1600px; margin:24px auto; padding:20px; box-sizing:border-box;}
        header{display:flex;align-items:center;gap:16px;margin-bottom:18px;}
        header h1{font-size:20px;margin:0;}
        header p{margin:0;color:var(--muted);font-size:13px;}
        .grid{display:grid;grid-template-columns:1fr;gap:16px;}
        @media(min-width:1000px){ .grid{grid-template-columns: 1fr 1fr;} }

        .card{
            background:var(--panel);
            padding:14px;
            border-radius:var(--radius);
            box-shadow:var(--card-shadow);
        }
        label{display:block;font-weight:600;margin-bottom:8px;}
        textarea{
            width:100%;min-height:500px;max-height:80vh;
            resize:vertical;padding:12px;box-sizing:border-box;
            font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
            font-size:13px;border-radius:8px;border:1px solid #e6e9ee;
            background:#fcfdff;color:#0f172a;
        }
        .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap;}
        button{
            background:var(--accent);color:white;border:none;
            padding:8px 12px;border-radius:8px;cursor:pointer;
            font-weight:600;box-shadow:0 4px 10px rgba(37,99,235,0.12);
        }
        button[disabled]{opacity:0.5;cursor:not-allowed;box-shadow:none;}
        .secondary{background:#e5e7eb;color:#111827;box-shadow:none;font-weight:600;}
        .muted{color:var(--muted);font-size:13px}
        pre.result-box{
            background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;
            overflow:auto;white-space:pre-wrap;font-family:ui-monospace, monospace;font-size:13px;
            max-height:70vh;
        }
        .diff-entry{border-radius:8px;padding:10px;border:1px solid #e6edf6;background:#fff;}
        .diff-meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
        .tag{padding:4px 8px;border-radius:6px;font-weight:700;font-size:12px}
        .tag.modified{background:var(--modified-bg);color:#a16207;border:1px solid #ffecb6;}
        .tag.added{background:var(--added-bg);color:#065f46;border:1px solid #b6f0c6;}
        .tag.removed{background:var(--removed-bg);color:#7f1d1d;border:1px solid #ffcfce;}
        footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    </style>
</head>
<body>
<div class="container">
    <header>
        <div>
            <h1>CodeLeader â€” æ§‹é€ è§£æ & å·®åˆ†è§£æ</h1>
            <p>ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ç¿’æ…£åŒ–ç›®çš„ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™</p>
        </div>
    </header>

    <div class="grid">
        <!-- å·¦ï¼šå…¥åŠ› -->
        <div class="card">
            <label for="code-input">æ§‹é€ è§£æ â€” Javaã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</label>
            <textarea id="code-input" placeholder="ã“ã“ã« Java ã®ã‚½ãƒ¼ã‚¹å…¨æ–‡ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
            <div class="controls">
                <button id="analyze-btn">æ§‹é€ è§£æï¼ˆé€ä¿¡ï¼‰</button>
                <button id="save-snapshot" class="secondary">ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜</button>
                <button id="restore-structure" class="secondary">ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå¾©å…ƒ</button>
                <span id="status" class="muted"></span>
            </div>

            <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7;" />

            <label for="day2-old-code">å·®åˆ†è§£æ â€” æ—§ã‚³ãƒ¼ãƒ‰</label>
            <textarea id="day2-old-code" placeholder="ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ï¼ˆæ—§ï¼‰ã‚’ã“ã“ã«"></textarea>
            <div class="controls">
                <button id="restore-old" class="secondary">ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå¾©å…ƒ</button>
            </div>

            <label for="day2-new-code" style="margin-top:8px;">æ–°ã‚³ãƒ¼ãƒ‰</label>
            <textarea id="day2-new-code" placeholder="æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ï¼ˆæ–°ï¼‰ã‚’ã“ã“ã«"></textarea>
            <div class="controls">
                <button id="restore-new" class="secondary">ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå¾©å…ƒ</button>
            </div>

            <div class="controls" style="margin-top:8px;">
                <button id="day2-diff-btn">å·®åˆ†è§£æï¼ˆé€ä¿¡ï¼‰</button>
                <button id="clear-btn" class="secondary">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
                <span class="note">å·®åˆ†ã¯è¡Œå˜ä½ã§æ¤œå‡ºã•ã‚Œã¾ã™ã€‚</span>
            </div>
        </div>

        <!-- å³ï¼šçµæœ -->
        <div class="card">
            <label>æ§‹é€ è§£æ çµæœ</label>
            <pre id="day1-result" class="result-box">æ§‹é€ è§£æã®çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</pre>

            <label style="margin-top:12px">å·®åˆ†è§£æ çµæœï¼ˆå…¨ã‚¨ãƒ³ãƒˆãƒªï¼‰</label>
            <div id="diff-results" style="margin-top:8px;"></div>

            <label style="margin-top:12px">å·®åˆ†ï¼ˆraw JSONï¼‰</label>
            <pre id="day2-result" class="result-box">å·®åˆ†ã® raw JSON ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</pre>
        </div>
    </div>

    <footer>Â© CodeLeader demo</footer>
</div>

<script>
    (() => {
        const codeInput = document.getElementById('code-input');
        const analyzeBtn = document.getElementById('analyze-btn');
        const saveSnapshotBtn = document.getElementById('save-snapshot');
        const statusSpan = document.getElementById('status');

        const oldCodeEl = document.getElementById('day2-old-code');
        const newCodeEl = document.getElementById('day2-new-code');
        const diffBtn = document.getElementById('day2-diff-btn');
        const clearBtn = document.getElementById('clear-btn');

        const day1ResultPre = document.getElementById('day1-result');
        const day2ResultPre = document.getElementById('day2-result');
        const diffResultsDiv = document.getElementById('diff-results');

        function setStatus(msg, isError = false) {
            statusSpan.textContent = msg || '';
            statusSpan.style.color = isError ? '#b91c1c' : '#065f46';
        }

        async function postJson(url, body) {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        // ===== æ§‹é€ è§£æé€ä¿¡ =====
        analyzeBtn.addEventListener('click', async () => {
            const code = codeInput.value.trim();
            if (!code) return alert('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');

            analyzeBtn.disabled = true;
            setStatus('æ§‹é€ è§£æã‚’é€ä¿¡ä¸­â€¦');
            day1ResultPre.textContent = '';
            try {
                const data = await postJson('/api/analysis/parse-structure', { code });
                day1ResultPre.textContent = JSON.stringify(data, null, 2);
                setStatus('æ§‹é€ è§£æå®Œäº†');
                localStorage.setItem('lastParsedCode', code);
            } catch (err) {
                day1ResultPre.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.message;
                setStatus('è§£æã‚¨ãƒ©ãƒ¼', true);
            } finally {
                analyzeBtn.disabled = false;
                setTimeout(()=>setStatus(''), 2000);
            }
        });

        // ===== ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ =====
        saveSnapshotBtn.addEventListener('click', () => {
            const code = codeInput.value.trim();
            if (!code) return alert('ä¿å­˜ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™ã€‚');
            localStorage.setItem('lastParsedCode', code);
            setStatus('ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            setTimeout(()=>setStatus(''),1600);
        });

        // ===== å„æ¬„ã¸ã®å¾©å…ƒ =====
        function restoreSnapshot(target) {
            const snap = localStorage.getItem('lastParsedCode');
            if (!snap) return alert('ä¿å­˜ã•ã‚ŒãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            target.value = snap;
            setStatus('ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å¾©å…ƒã—ã¾ã—ãŸ');
            setTimeout(()=>setStatus(''),1600);
        }
        document.getElementById('restore-structure').addEventListener('click', ()=>restoreSnapshot(codeInput));
        document.getElementById('restore-old').addEventListener('click', ()=>restoreSnapshot(oldCodeEl));
        document.getElementById('restore-new').addEventListener('click', ()=>restoreSnapshot(newCodeEl));

// ===== å·®åˆ†è§£æé€ä¿¡ =====
diffBtn.addEventListener('click', async () => {
    const oldSrc = oldCodeEl.value.trim();
    const newSrc = newCodeEl.value.trim();
    if (!oldSrc || !newSrc) return alert('æ—§ã‚³ãƒ¼ãƒ‰ã¨æ–°ã‚³ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    diffBtn.disabled = true;
    setStatus('å·®åˆ†è§£æä¸­â€¦');
    try {
        const data = await postJson('/api/diff', { oldSource: oldSrc, newSource: newSrc });
        day2ResultPre.textContent = JSON.stringify(data, null, 2);
        setStatus('å·®åˆ†è§£æå®Œäº†');

        // ğŸ§© å·®åˆ†ãƒªã‚¹ãƒˆã®æç”»ã‚’å¾©å…ƒ
        diffResultsDiv.innerHTML = '';
        if (Array.isArray(data) && data.length > 0) {
            data.forEach(diff => {
                const div = document.createElement('div');
                div.className = 'diff-entry';

                const tagClass =
                    diff['ç¨®é¡'] === 'DELETE' ? 'removed' :
                    diff['ç¨®é¡'] === 'INSERT' ? 'added' : 'modified';

                div.innerHTML = `
                    <div class="diff-meta">
                        <span class="tag ${tagClass}">${diff['ç¨®é¡']}</span>
                        <span>å…ƒä½ç½®: ${diff['å…ƒã®ä½ç½®']}, æ–°ä½ç½®: ${diff['å¤‰æ›´å¾Œä½ç½®']}</span>
                    </div>
                    <div><strong>å…ƒã‚³ãƒ¼ãƒ‰:</strong><pre>${(diff['å…ƒã‚³ãƒ¼ãƒ‰'] || []).join('\n')}</pre></div>
                    <div><strong>æ–°ã‚³ãƒ¼ãƒ‰:</strong><pre>${(diff['æ–°ã‚³ãƒ¼ãƒ‰'] || []).join('\n')}</pre></div>
                `;
                diffResultsDiv.appendChild(div);
            });
        } else {
            diffResultsDiv.innerHTML = '<div class="muted">å·®åˆ†ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        }

    } catch (err) {
        day2ResultPre.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.message;
        setStatus('å·®åˆ†è§£æã‚¨ãƒ©ãƒ¼', true);
    } finally {
        diffBtn.disabled = false;
        setTimeout(()=>setStatus(''),2000);
    }
});


        // ===== å…¥åŠ›ã‚¯ãƒªã‚¢ =====
        clearBtn.addEventListener('click', () => {
            if (!confirm('å…¥åŠ›æ¬„ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
            codeInput.value = '';
            oldCodeEl.value = '';
            newCodeEl.value = '';
            day1ResultPre.textContent = 'æ§‹é€ è§£æã®çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
            day2ResultPre.textContent = 'å·®åˆ†ã® raw JSON ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
            diffResultsDiv.innerHTML = '';
            setStatus('');
        });
    })();
</script>
</body>
</html>
