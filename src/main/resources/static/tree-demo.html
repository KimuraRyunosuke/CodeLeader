<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CodeLeader Tree Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <style>
        body { display:flex; height:100vh; margin:0; font-family:sans-serif; }

        /* 左ペイン：ツリー */
        #left-pane { width:40%; border-right:1px solid #ccc; overflow:auto; padding:10px; }

        /* 右ペイン：ノード詳細 + 構造解析 */
        #right-pane { width:60%; border-left:1px solid #ccc; overflow:auto; padding:10px; }

        .code-block { background:#f5f5f5; padding:10px; white-space:pre-wrap; font-family:monospace; }
        .modified { background-color:#ffe5e5; }
        .added    { background-color:#e5ffe5; }
        .deleted  { background-color:#e5e5ff; }
    </style>
</head>
<body>

<!-- 左ペイン：ツリー -->
<div id="left-pane">
    <div id="tree"></div>
</div>

<!-- 右ペイン：ノード詳細 + 構造解析 -->
<div id="right-pane">
    <h3 id="node-title">ノード詳細</h3>
    <pre id="node-source" class="code-block"></pre>

    <h3>構造解析結果</h3>
    <pre id="structure-result" class="code-block"></pre>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

<script>
    // ────────── ツリーデータ ──────────
    const treeData = [
        {
            "id": "Hello.java",
            "text": "Hello.java",
            "children": [
                { "id": "Hello.java:greet", "text": "greet()" }
            ]
        }
    ];

    // jsTree 初期化
    $('#tree').jstree({ 'core': { 'data': treeData } });

    // ────────── 構造解析呼び出し関数 ──────────
    async function parseStructure(code) {
        try {
            const res = await fetch('/api/analysis/parse-structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });
            const json = await res.json();
            document.getElementById('structure-result').textContent = JSON.stringify(json, null, 2);
        } catch (err) {
            console.error(err);
            document.getElementById('structure-result').textContent = "構造解析エラー";
        }
    }

    // ────────── ノード詳細取得 & 右ペイン更新 ──────────
    $('#tree').on("select_node.jstree", function (e, data) {
        const nodeId = data.node.id;
        fetch(`/api/code/node/${encodeURIComponent(nodeId)}`)
            .then(res => res.json())
            .then(nodeData => {
                // ノード詳細表示
                document.getElementById("node-title").innerText =
                    `${nodeData.type}: ${nodeData.name} (行 ${nodeData.startLine}-${nodeData.endLine})`;
                document.getElementById("node-source").textContent = nodeData.source;
                document.getElementById("node-source").className = "code-block " + (nodeData.diffStatus || "");

                // 構造解析も同時に呼び出し
                parseStructure(nodeData.source);
            })
            .catch(err => {
                console.error(err);
                document.getElementById("node-title").innerText = "ノード詳細取得エラー";
                document.getElementById("node-source").textContent = "";
                document.getElementById("structure-result").textContent = "";
            });
    });
</script>

</body>
</html>
