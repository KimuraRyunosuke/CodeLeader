<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>CodeLeader — 構造解析＆差分解析（JSON表示版）</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root{
            --bg:#f4f6f8;
            --panel:#ffffff;
            --muted:#6b7280;
            --accent:#2563eb;
            --added-bg:#e6ffed;
            --removed-bg:#ffecec;
            --modified-bg:#fff7e6;
            --card-shadow: 0 6px 18px rgba(15,23,42,0.08);
            --radius:10px;
        }
        html,body{height:100%; margin:0; font-family: Inter, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; background:var(--bg); color:#111827;}
        .container{max-width:1600px; margin:24px auto; padding:20px; box-sizing:border-box;}
        header{display:flex;align-items:center;gap:16px;margin-bottom:18px;}
        header h1{font-size:20px;margin:0;}
        header p{margin:0;color:var(--muted);font-size:13px;}
        .grid{display:grid;grid-template-columns:1fr;gap:16px;}
        @media(min-width:1000px){ .grid{grid-template-columns: 1fr 1fr;} }
        .card{background:var(--panel); padding:14px; border-radius:var(--radius); box-shadow:var(--card-shadow);}
        label{display:block;font-weight:600;margin-bottom:8px;}
        textarea{width:100%;min-height:500px;max-height:80vh; resize:vertical;padding:12px;box-sizing:border-box;
            font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
            font-size:13px;border-radius:8px;border:1px solid #e6e9ee;background:#fcfdff;color:#0f172a;}
        .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap;}
        button{background:var(--accent);color:white;border:none; padding:8px 12px;border-radius:8px;cursor:pointer;
            font-weight:600;box-shadow:0 4px 10px rgba(37,99,235,0.12);}
        button[disabled]{opacity:0.5;cursor:not-allowed;box-shadow:none;}
        .secondary{background:#e5e7eb;color:#111827;box-shadow:none;font-weight:600;}
        .muted{color:var(--muted);font-size:13px}
        select {padding:6px 8px;border-radius:6px;border:1px solid #d1d5db;background:white;font-size:13px;}
        pre.result-box{background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap;
            font-family:ui-monospace, monospace;font-size:13px;max-height:70vh;}
        .diff-entry{border-radius:8px;padding:10px;border:1px solid #e6edf6;background:#fff;}
        .diff-meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
        .tag{padding:4px 8px;border-radius:6px;font-weight:700;font-size:12px}
        .tag.modified{background:var(--modified-bg);color:#a16207;border:1px solid #ffecb6;}
        .tag.added{background:var(--added-bg);color:#065f46;border:1px solid #b6f0c6;}
        .tag.removed{background:var(--removed-bg);color:#7f1d1d;border:1px solid #ffcfce;}
        footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
        .note{font-size:12px;color:var(--muted);}
    </style>
</head>
<body>
<div class="container">
    <header>
        <div>
            <h1>CodeLeader — 構造解析 & 差分解析</h1>
            <p>コードリーディングの習慣化目的のWebアプリケーションです</p>
        </div>
    </header>

    <div class="grid">
        <!-- 左：入力 -->
        <div class="card">
            <label for="code-input">構造解析 — Javaコードを入力</label>
            <textarea id="code-input" placeholder="ここに Java のソース全文を貼り付けてください..."></textarea>
            <div class="controls">
                <button id="analyze-btn">構造解析（送信）</button>
                <button id="save-snapshot" class="secondary">スナップショット保存</button>
                <select id="snapshotList-structure">
                    <option value="">▼ 過去のスナップショット（選択で復元）</option>
                </select>
                <span id="status" class="muted"></span>
            </div>

            <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7;" />

            <label for="day2-old-code">差分解析 — 旧コード</label>
            <textarea id="day2-old-code" placeholder="以前のコード（旧）をここに"></textarea>
            <div class="controls">
                <select id="snapshotList-diff-old">
                    <option value="">▼ 過去のスナップショット（選択で復元）</option>
                </select>
            </div>

            <label for="day2-new-code" style="margin-top:8px;">新コード</label>
            <textarea id="day2-new-code" placeholder="新しいコード（新）をここに"></textarea>
            <div class="controls">
                <select id="snapshotList-diff-new">
                    <option value="">▼ 過去のスナップショット（選択で復元）</option>
                </select>
            </div>

            <div class="controls" style="margin-top:8px;">
                <button id="day2-diff-btn">差分解析（送信）</button>
                <button id="clear-btn" class="secondary">入力クリア</button>
                <span class="note">差分は行単位で検出されます。</span>
            </div>
        </div>

        <!-- 右：結果 -->
        <div class="card">
            <label>構造解析 結果</label>
            <pre id="day1-result" class="result-box">構造解析の結果がここに表示されます</pre>

            <label style="margin-top:12px">差分解析 結果（全エントリ）</label>
            <div id="diff-results" style="margin-top:8px;"></div>

            <label style="margin-top:12px">差分（raw JSON）</label>
            <pre id="day2-result" class="result-box">差分の raw JSON がここに表示されます</pre>
        </div>
    </div>

    <footer>© CodeLeader demo</footer>
</div>

<script>
    (() => {
        const codeInput = document.getElementById('code-input');
        const analyzeBtn = document.getElementById('analyze-btn');
        const saveSnapshotBtn = document.getElementById('save-snapshot');
        const statusSpan = document.getElementById('status');
        const oldCodeEl = document.getElementById('day2-old-code');
        const newCodeEl = document.getElementById('day2-new-code');
        const diffBtn = document.getElementById('day2-diff-btn');
        const clearBtn = document.getElementById('clear-btn');
        const day1ResultPre = document.getElementById('day1-result');
        const day2ResultPre = document.getElementById('day2-result');
        const diffResultsDiv = document.getElementById('diff-results');

        function setStatus(msg, isError = false) {
            statusSpan.textContent = msg || '';
            statusSpan.style.color = isError ? '#b91c1c' : '#065f46';
        }

        async function postJson(url, body) {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        // ===== スナップショット管理 =====
        function saveSnapshot(code) {
            if (!code || !code.trim()) return alert('空のコードは保存できません。');
            const name = prompt('スナップショット名を入力してください（未入力の場合は日時）') || new Date().toISOString();
            const all = JSON.parse(localStorage.getItem('snapshots') || '[]');
            all.push({ id: new Date().toISOString(), name, code });
            while (all.length > 10) all.shift();
            localStorage.setItem('snapshots', JSON.stringify(all));
            updateSnapshotLists();
            setStatus('スナップショットを保存しました');
            setTimeout(()=>setStatus(''),1600);
        }

        function updateSnapshotLists() {
            const lists = [
                document.getElementById('snapshotList-structure'),
                document.getElementById('snapshotList-diff-old'),
                document.getElementById('snapshotList-diff-new')
            ].filter(Boolean);
            const all = JSON.parse(localStorage.getItem('snapshots') || '[]');
            const opts = all.slice().reverse().map(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                return opt;
            });
            lists.forEach(list => {
                list.innerHTML = '<option value="">▼ 過去のスナップショット（選択で復元）</option>';
                opts.forEach(o => list.appendChild(o.cloneNode(true)));
            });
        }

        function loadSnapshotTo(targetId, listId) {
            const list = document.getElementById(listId);
            const id = list.value;
            if (!id) return;
            const all = JSON.parse(localStorage.getItem('snapshots') || '[]');
            const snap = all.find(s => s.id === id);
            if (!snap) return;
            document.getElementById(targetId).value = snap.code;
            setStatus('スナップショットを復元しました');
            setTimeout(()=>setStatus(''),1600);
        }

        function renameSnapshot(listId) {
            const list = document.getElementById(listId);
            const id = list.value;
            if (!id) return alert('変更するスナップショットを選択してください。');
            const all = JSON.parse(localStorage.getItem('snapshots') || '[]');
            const snap = all.find(s => s.id === id);
            if (!snap) return;
            const newName = prompt('新しいスナップショット名を入力してください', snap.name);
            if (!newName) return;
            snap.name = newName;
            localStorage.setItem('snapshots', JSON.stringify(all));
            updateSnapshotLists();
            setStatus('スナップショット名を更新しました');
            setTimeout(() => setStatus(''), 1600);
        }

        window.addEventListener('load', () => {
            updateSnapshotLists();

            document.getElementById('snapshotList-structure').addEventListener('change',()=>loadSnapshotTo('code-input','snapshotList-structure'));
            document.getElementById('snapshotList-diff-old').addEventListener('change',()=>loadSnapshotTo('day2-old-code','snapshotList-diff-old'));
            document.getElementById('snapshotList-diff-new').addEventListener('change',()=>loadSnapshotTo('day2-new-code','snapshotList-diff-new'));

            // 名前変更ボタン追加
            [ ['snapshotList-structure', 'code-input'],
              ['snapshotList-diff-old', 'day2-old-code'],
              ['snapshotList-diff-new', 'day2-new-code'] ].forEach(([listId, target]) => {
                const list = document.getElementById(listId);
                const btn = document.createElement('button');
                btn.textContent = '名前変更';
                btn.className = 'secondary';
                btn.addEventListener('click', () => renameSnapshot(listId));
                list.parentElement.appendChild(btn);
            });
        });

        analyzeBtn.addEventListener('click', async () => {
            const code = codeInput.value.trim();
            if (!code) return alert('コードを入力してください。');
            analyzeBtn.disabled = true;
            setStatus('構造解析を送信中…');
            day1ResultPre.textContent = '';
            try {
                const data = await postJson('/api/analysis/parse-structure', { code });
                day1ResultPre.textContent = JSON.stringify(data, null, 2);
                localStorage.setItem('lastParsedCode', code);
                setStatus('構造解析完了');
            } catch (err) {
                day1ResultPre.textContent = 'エラー: ' + err.message;
                setStatus('解析エラー', true);
            } finally {
                analyzeBtn.disabled = false;
                setTimeout(()=>setStatus(''), 2000);
            }
        });

        saveSnapshotBtn.addEventListener('click', () => {
            const code = codeInput.value.trim();
            if (!code) return alert('保存するコードが空です。');
            saveSnapshot(code);
            localStorage.setItem('lastParsedCode', code);
        });

        diffBtn.addEventListener('click', async () => {
            const oldSrc = oldCodeEl.value.trim();
            const newSrc = newCodeEl.value.trim();
            if (!oldSrc || !newSrc) return alert('旧コードと新コードの両方を入力してください');
            diffBtn.disabled = true;
            setStatus('差分解析中…');
            day2ResultPre.textContent = '';
            diffResultsDiv.innerHTML = '';
            try {
                const resp = await postJson('/api/diff', { oldSource: oldSrc, newSource: newSrc });
                day2ResultPre.textContent = JSON.stringify(resp, null, 2);
            } catch (err) {
                day2ResultPre.textContent = 'エラー: ' + err.message;
                setStatus('差分解析エラー', true);
            } finally {
                diffBtn.disabled = false;
                setTimeout(()=>setStatus(''),2200);
            }
        });

        clearBtn.addEventListener('click', () => {
            if (!confirm('入力欄をすべてクリアしますか？')) return;
            codeInput.value = '';
            oldCodeEl.value = '';
            newCodeEl.value = '';
            day1ResultPre.textContent = '構造解析の結果がここに表示されます';
            day2ResultPre.textContent = '差分の raw JSON がここに表示されます';
            diffResultsDiv.innerHTML = '';
            setStatus('');
        });
    })();
</script>
</body>
</html>
