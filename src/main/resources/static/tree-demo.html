<!-- 右ペイン：構造解析結果 -->
<div id="right-pane">
    <h3>ノード詳細</h3>
    <pre id="node-source" class="code-block"></pre>

    <h3>構造解析結果</h3>
    <pre id="structure-result" class="code-block"></pre>
</div>

<script>
    async function parseStructure(code) {
        try {
            const res = await fetch('/api/analysis/parse-structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });
            const json = await res.json();
            document.getElementById('structure-result').textContent = JSON.stringify(json, null, 2);
        } catch (err) {
            console.error(err);
            document.getElementById('structure-result').textContent = "構造解析エラー";
        }
    }

    // ツリー選択時に右ペインの構造解析も更新
    $('#tree').on("select_node.jstree", function (e, data) {
        const nodeId = data.node.id;
        fetch(`/api/code/node/${encodeURIComponent(nodeId)}`)
            .then(res => res.json())
            .then(nodeData => {
                document.getElementById("node-title").innerText =
                    `${nodeData.type}: ${nodeData.name} (行 ${nodeData.startLine}-${nodeData.endLine})`;
                document.getElementById("node-source").textContent = nodeData.source;
                document.getElementById("node-source").className = "code-block " + (nodeData.diffStatus || "");

                // 構造解析も同時に呼び出し
                parseStructure(nodeData.source);
            })
            .catch(err => {
                console.error(err);
                document.getElementById("node-title").innerText = "ノード詳細取得エラー";
                document.getElementById("node-source").textContent = "";
                document.getElementById("structure-result").textContent = "";
            });
    });
</script>
